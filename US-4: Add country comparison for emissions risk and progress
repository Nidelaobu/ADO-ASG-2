-- SQL: Emissions Risk + Progress (Latest year vs 10 years ago)

WITH latest_year AS (
SELECT MAX(YEAR_ID) AS Y
FROM FACT_ELECTRICITY
)

SELECT
dl.COUNTRY_NAME AS COUNTRY,
ly.Y AS LATEST_YEAR,

/* ===== Latest metrics ===== */
ROUND(fe.GREENHOUSE_GAS_EMISSIONS / NULLIF(eco.POPULATION, 0), 6) AS GHG_PER_CAPITA,
ROUND(ff.TOTAL_SHARE, 1) AS FOSSIL_SHARE_PCT,
ROUND(fr.TOTAL_SHARE, 1) AS RENEWABLES_SHARE_PCT,

/* ===== Risk Level ===== */
CASE
WHEN fe.GREENHOUSE_GAS_EMISSIONS IS NULL OR eco.POPULATION IS NULL OR ff.TOTAL_SHARE IS NULL THEN 'UNKNOWN'
WHEN (fe.GREENHOUSE_GAS_EMISSIONS / NULLIF(eco.POPULATION, 0)) >= 0.000010 AND ff.TOTAL_SHARE >= 70 THEN 'HIGH'
WHEN (fe.GREENHOUSE_GAS_EMISSIONS / NULLIF(eco.POPULATION, 0)) >= 0.000005 AND ff.TOTAL_SHARE >= 50 THEN 'MEDIUM'
ELSE 'LOW'
END AS RISK_LEVEL,

/* ===== Progress vs 10 years ago ===== */
(ly.Y - 10) AS PAST_YEAR,
ROUND(fe_p.GREENHOUSE_GAS_EMISSIONS / NULLIF(eco_p.POPULATION, 0), 6) AS GHG_PER_CAPITA_10Y_AGO,
ROUND(
(fe.GREENHOUSE_GAS_EMISSIONS / NULLIF(eco.POPULATION, 0))
- (fe_p.GREENHOUSE_GAS_EMISSIONS / NULLIF(eco_p.POPULATION, 0))
, 6) AS GHG_PER_CAPITA_CHANGE_10Y,

ROUND(fr_p.TOTAL_SHARE, 1) AS RENEWABLES_SHARE_10Y_AGO,
ROUND(fr.TOTAL_SHARE - fr_p.TOTAL_SHARE, 1) AS RENEWABLES_SHARE_CHANGE_10Y

FROM latest_year ly
JOIN DIM_LOCATION dl
ON 1=1

LEFT JOIN FACT_ELECTRICITY fe
ON fe.LOCATION_ID = dl.LOCATION_ID AND fe.YEAR_ID = ly.Y
LEFT JOIN FACT_ECONOMY eco
ON eco.LOCATION_ID = dl.LOCATION_ID AND eco.YEAR_ID = ly.Y
LEFT JOIN FACT_FOSSIL_TOTAL ff
ON ff.LOCATION_ID = dl.LOCATION_ID AND ff.YEAR_ID = ly.Y
LEFT JOIN FACT_RENEWABLES_TOTAL fr
ON fr.LOCATION_ID = dl.LOCATION_ID AND fr.YEAR_ID = ly.Y

LEFT JOIN FACT_ELECTRICITY fe_p
ON fe_p.LOCATION_ID = dl.LOCATION_ID AND fe_p.YEAR_ID = (ly.Y - 10)
LEFT JOIN FACT_ECONOMY eco_p
ON eco_p.LOCATION_ID = dl.LOCATION_ID AND eco_p.YEAR_ID = (ly.Y - 10)
LEFT JOIN FACT_RENEWABLES_TOTAL fr_p
ON fr_p.LOCATION_ID = dl.LOCATION_ID AND fr_p.YEAR_ID = (ly.Y - 10)

WHERE dl.LOCATION_ID IS NOT NULL
AND dl.LOCATION_ID NOT LIKE 'OWID_%'   -- removes aggregates like OWID_WRL

ORDER BY RISK_LEVEL DESC, GHG_PER_CAPITA DESC;
