CREATE OR REPLACE VIEW VW_CO2_RISK_SCORE AS
WITH valid_data AS (
SELECT *
FROM VW_CO2_BASE
WHERE GHG_PER_CAPITA IS NOT NULL
AND GHG_PER_CAPITA > 0
),
p AS (
SELECT
PERCENTILE_CONT(0.33) WITHIN GROUP (ORDER BY GHG_PER_CAPITA) AS p33,
PERCENTILE_CONT(0.66) WITHIN GROUP (ORDER BY GHG_PER_CAPITA) AS p66
FROM valid_data
)
SELECT
b.LOCATION_ID,
b.COUNTRY_NAME,
b.YEAR_ID,
b.GHG_EMISSIONS,
b.POPULATION,
b.GHG_PER_CAPITA,



CASE
    WHEN b.GHG_PER_CAPITA IS NULL OR b.GHG_PER_CAPITA = 0 THEN 'LOW'
    WHEN b.GHG_PER_CAPITA <= p.p33 THEN 'LOW'
    WHEN b.GHG_PER_CAPITA <= p.p66 THEN 'MEDIUM'
    ELSE 'HIGH'
END AS CO2_RISK_LEVEL
FROM VW_CO2_BASE b
CROSS JOIN p;
