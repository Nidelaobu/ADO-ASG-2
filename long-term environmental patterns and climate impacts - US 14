/* 1) Base view: Yearly CO₂ + per-capita (reusable for other stories) */
CREATE OR REPLACE VIEW VW_CO2_BASE AS
SELECT
e.LOCATION_ID,
l.COUNTRY_NAME,
e.YEAR_ID,
e.GHG_EMISSIONS,
ec.POPULATION,
CASE
WHEN ec.POPULATION IS NULL OR ec.POPULATION = 0 OR e.GHG_EMISSIONS IS NULL THEN NULL
ELSE (e.GHG_EMISSIONS / ec.POPULATION)
END AS GHG_PER_CAPITA
FROM FACT_ELECTRICITY e
JOIN DIM_LOCATION l
ON e.LOCATION_ID = l.LOCATION_ID
LEFT JOIN FACT_ECONOMY ec
ON e.LOCATION_ID = ec.LOCATION_ID
AND e.YEAR_ID     = ec.YEAR_ID;

/* 2) Yearly historical view (limits to a sensible analysis window) */
CREATE OR REPLACE VIEW VW_CO2_HISTORICAL_YEARLY AS
SELECT
LOCATION_ID,
COUNTRY_NAME,
YEAR_ID,
GHG_EMISSIONS,
POPULATION,
GHG_PER_CAPITA
FROM VW_CO2_BASE
WHERE GHG_EMISSIONS IS NOT NULL
AND YEAR_ID BETWEEN 1950 AND EXTRACT(YEAR FROM CURRENT_DATE);

/* 3) Decade aggregation (total + average per decade) */
CREATE OR REPLACE VIEW VW_CO2_BY_DECADE AS
SELECT
LOCATION_ID,
COUNTRY_NAME,
(YEAR_ID / 10) * 10 AS DECADE,
SUM(GHG_EMISSIONS) AS TOTAL_EMISSIONS,
AVG(GHG_EMISSIONS) AS AVG_EMISSIONS
FROM VW_CO2_BASE
WHERE GHG_EMISSIONS IS NOT NULL
AND YEAR_ID BETWEEN 1950 AND EXTRACT(YEAR FROM CURRENT_DATE)
GROUP BY
LOCATION_ID,
COUNTRY_NAME,
(YEAR_ID / 10) * 10;

/* 4) Trend view: decade-over-decade change */
CREATE OR REPLACE VIEW VW_CO2_DECADE_TREND AS
SELECT
LOCATION_ID,
COUNTRY_NAME,
DECADE,
AVG_EMISSIONS,
AVG_EMISSIONS
- LAG(AVG_EMISSIONS) OVER (PARTITION BY LOCATION_ID ORDER BY DECADE)
AS DECADE_CHANGE
FROM VW_CO2_BY_DECADE;

/* 5) Filtered decade view: keep only countries with enough decades
(fixes “missing early decades” blocker) /
CREATE OR REPLACE VIEW VW_CO2_DECADE_FILTERED AS
SELECT *
FROM VW_CO2_BY_DECADE
QUALIFY COUNT() OVER (PARTITION BY LOCATION_ID) >= 5;

/* 6) Filtered trend view (trend only for sufficiently-covered countries) */
CREATE OR REPLACE VIEW VW_CO2_DECADE_TREND_FILTERED AS
SELECT
LOCATION_ID,
COUNTRY_NAME,
DECADE,
AVG_EMISSIONS,
AVG_EMISSIONS
- LAG(AVG_EMISSIONS) OVER (PARTITION BY LOCATION_ID ORDER BY DECADE)
AS DECADE_CHANGE
FROM VW_CO2_DECADE_FILTERED;
