-- CREATE VIEW FOR US-19 - ENERGY MIX BY COUNTRY
-- ================================================================================
-- This view combines all energy sources with calculated percentages
-- Use this for your Power BI stacked bar chart

CREATE OR REPLACE VIEW VW_ENERGY_MIX_BY_COUNTRY AS
SELECT
f.ISO_CODE,
f.COUNTRY_NAME,
f.YEAR,

-- Raw consumption values (TWh)
f.TOTAL_FOSSIL_CONSUMPTION,
r.TOTAL_RENEWABLES_CONSUMPTION,
n.NUCLEAR_CONSUMPTION,

-- Total energy consumption
(COALESCE(f.TOTAL_FOSSIL_CONSUMPTION, 0) +
COALESCE(r.TOTAL_RENEWABLES_CONSUMPTION, 0) +
COALESCE(n.NUCLEAR_CONSUMPTION, 0)) AS TOTAL_ENERGY,

-- Percentage calculations (for stacked charts)
ROUND(
COALESCE(f.TOTAL_FOSSIL_CONSUMPTION, 0) /
NULLIF((COALESCE(f.TOTAL_FOSSIL_CONSUMPTION, 0) +
COALESCE(r.TOTAL_RENEWABLES_CONSUMPTION, 0) +
COALESCE(n.NUCLEAR_CONSUMPTION, 0)), 0) * 100,
2
) AS FOSSIL_PCT,

ROUND(
COALESCE(r.TOTAL_RENEWABLES_CONSUMPTION, 0) /
NULLIF((COALESCE(f.TOTAL_FOSSIL_CONSUMPTION, 0) +
COALESCE(r.TOTAL_RENEWABLES_CONSUMPTION, 0) +
COALESCE(n.NUCLEAR_CONSUMPTION, 0)), 0) * 100,
2
) AS RENEWABLES_PCT,

ROUND(
COALESCE(n.NUCLEAR_CONSUMPTION, 0) /
NULLIF((COALESCE(f.TOTAL_FOSSIL_CONSUMPTION, 0) +
COALESCE(r.TOTAL_RENEWABLES_CONSUMPTION, 0) +
COALESCE(n.NUCLEAR_CONSUMPTION, 0)), 0) * 100,
2
) AS NUCLEAR_PCT,

-- Classification
CASE
WHEN f.FOSSIL_SHARE_OF_ENERGY_PCT > 80 THEN 'Highly Fossil Dependent'
WHEN f.FOSSIL_SHARE_OF_ENERGY_PCT > 60 THEN 'Fossil Dependent'
WHEN r.RENEWABLES_SHARE_OF_ENERGY_PCT > 50 THEN 'Renewable Leader'
WHEN n.SHARE_OF_ENERGY_PCT > 40 THEN 'Nuclear Significant'
ELSE 'Balanced Mix'
END AS ENERGY_TYPE_CLASSIFICATION,

-- Economy data for additional analysis
e.POPULATION,
e.GDP,
e.GDP_PER_CAPITA,

-- Per capita energy consumption (kWh per person)
ROUND(
(COALESCE(f.TOTAL_FOSSIL_CONSUMPTION, 0) +
COALESCE(r.TOTAL_RENEWABLES_CONSUMPTION, 0) +
COALESCE(n.NUCLEAR_CONSUMPTION, 0)) * 1000000000 /
NULLIF(e.POPULATION, 0) / 1000,
2
) AS ENERGY_PER_CAPITA_KWH,

-- Flags for filtering
f.IS_FOSSIL_DEPENDENT,
r.IS_GREEN_ECONOMY,
n.HAS_NUCLEAR_CAPACITY,

-- Timestamp
CURRENT_TIMESTAMP() AS CREATED_AT

FROM FACT_FOSSIL_TOTAL f
LEFT JOIN FACT_RENEWABLES_TOTAL r
ON f.ISO_CODE = r.ISO_CODE AND f.YEAR = r.YEAR
LEFT JOIN FACT_NUCLEAR n
ON f.ISO_CODE = n.ISO_CODE AND f.YEAR = n.YEAR
LEFT JOIN FACT_ECONOMY e
ON f.ISO_CODE = e.ISO_CODE AND f.YEAR = e.YEAR

WHERE (COALESCE(f.TOTAL_FOSSIL_CONSUMPTION, 0) +
COALESCE(r.TOTAL_RENEWABLES_CONSUMPTION, 0) +
COALESCE(n.NUCLEAR_CONSUMPTION, 0)) > 0 -- Exclude countries with no data

ORDER BY f.YEAR DESC, TOTAL_ENERGY DESC;

 

SELECT * FROM VW_ENERGY_MIX_BY_COUNTRY
WHERE YEAR = 2022
LIMIT 10;

 

 

-- ================================================================================
-- CREATE VIEW FOR US-19 - FOSSIL FUEL BREAKDOWN
-- ================================================================================

CREATE OR REPLACE VIEW VW_FOSSIL_FUEL_BREAKDOWN AS
SELECT
    c.ISO_CODE,
    c.COUNTRY_NAME,
    c.YEAR,
    
    -- Individual fossil fuel consumption
    COALESCE(c.COAL_CONSUMPTION, 0) AS COAL_CONSUMPTION,
    COALESCE(o.OIL_CONSUMPTION, 0) AS OIL_CONSUMPTION,
    COALESCE(g.GAS_CONSUMPTION, 0) AS GAS_CONSUMPTION,
    
    -- Total fossil
    (COALESCE(c.COAL_CONSUMPTION, 0) +
     COALESCE(o.OIL_CONSUMPTION, 0) +
     COALESCE(g.GAS_CONSUMPTION, 0)) AS TOTAL_FOSSIL,
    
    -- Percentages of fossil fuel mix
    ROUND(
        COALESCE(c.COAL_CONSUMPTION, 0) /
        NULLIF((COALESCE(c.COAL_CONSUMPTION, 0) +
                COALESCE(o.OIL_CONSUMPTION, 0) +
                COALESCE(g.GAS_CONSUMPTION, 0)), 0) * 100,
        2
    ) AS COAL_PCT_OF_FOSSIL,
    
    ROUND(
        COALESCE(o.OIL_CONSUMPTION, 0) /
        NULLIF((COALESCE(c.COAL_CONSUMPTION, 0) +
                COALESCE(o.OIL_CONSUMPTION, 0) +
                COALESCE(g.GAS_CONSUMPTION, 0)), 0) * 100,
        2
    ) AS OIL_PCT_OF_FOSSIL,
    
    ROUND(
        COALESCE(g.GAS_CONSUMPTION, 0) /
        NULLIF((COALESCE(c.COAL_CONSUMPTION, 0) +
                COALESCE(o.OIL_CONSUMPTION, 0) +
                COALESCE(g.GAS_CONSUMPTION, 0)), 0) * 100,
        2
    ) AS GAS_PCT_OF_FOSSIL,
    
    -- Production flags
    c.HAS_COAL_PRODUCTION,
    o.IS_NET_EXPORTER AS IS_OIL_EXPORTER,
    g.IS_NET_EXPORTER AS IS_GAS_EXPORTER,
    
    CURRENT_TIMESTAMP() AS CREATED_AT

FROM FACT_COAL c
LEFT JOIN FACT_OIL o
    ON c.ISO_CODE = o.ISO_CODE AND c.YEAR = o.YEAR
LEFT JOIN FACT_GAS g
    ON c.ISO_CODE = g.ISO_CODE AND c.YEAR = g.YEAR

WHERE (COALESCE(c.COAL_CONSUMPTION, 0) +
       COALESCE(o.OIL_CONSUMPTION, 0) +
       COALESCE(g.GAS_CONSUMPTION, 0)) > 0

ORDER BY c.YEAR DESC, TOTAL_FOSSIL DESC;

 

-- Test the view
SELECT * FROM VW_FOSSIL_FUEL_BREAKDOWN
WHERE YEAR = 2024
LIMIT 10;
