CREATE OR REPLACE TABLE DIM_LOCATION AS
SELECT DISTINCT
    iso_code AS LOCATION_ID,
    country AS COUNTRY_NAME
FROM OWID_ENERGY_DATA_RAW
WHERE iso_code IS NOT NULL
AND LENGTH(iso_code) = 3;

CREATE OR REPLACE TABLE DIM_DATE AS
SELECT DISTINCT
    year AS YEAR_ID
FROM OWID_ENERGY_DATA_RAW;

CREATE OR REPLACE TABLE FACT_ECONOMY AS
SELECT
    iso_code AS LOCATION_ID,
    year AS YEAR_ID,
    CASE 
        WHEN population < 0 THEN NULL 
        ELSE population 
    END AS population,
    CASE 
        WHEN gdp < 0 THEN NULL 
        ELSE ROUND(gdp, 2) 
    END AS gdp
FROM OWID_ENERGY_DATA_RAW
WHERE iso_code IS NOT NULL
AND LENGTH(iso_code) = 3
AND year BETWEEN 1900 AND EXTRACT(YEAR FROM CURRENT_DATE);

-- orphan check for FACT_ECONOMY
SELECT COUNT(*) AS ORPHAN_ROWS
FROM FACT_ECONOMY f
LEFT JOIN DIM_LOCATION d
  ON f.LOCATION_ID = d.LOCATION_ID
WHERE d.LOCATION_ID IS NULL;
SELECT COUNT(*) AS ORPHAN_ROWS
FROM FACT_ECONOMY f
LEFT JOIN DIM_DATE d
  ON f.YEAR_ID = d.YEAR_ID
WHERE d.YEAR_ID IS NULL;

CREATE OR REPLACE TABLE FACT_ELECTRICITY AS
SELECT
    iso_code AS LOCATION_ID,
    year AS YEAR_ID,
    COALESCE(electricity_demand, 0) AS DEMAND,
    COALESCE(electricity_generation, 0) AS GENERATION,
    COALESCE(per_capita_electricity, 0) AS PER_CAPITA,
    COALESCE(carbon_intensity_elec, 0) AS CARBON_INTENSITY,
    COALESCE(greenhouse_gas_emissions, 0) AS GHG_EMISSIONS
FROM OWID_ENERGY_DATA_RAW
WHERE iso_code IS NOT NULL
AND LENGTH(iso_code) = 3;

-- orphan check for FACT_ELECTRICITY
SELECT COUNT(*) AS ORPHAN_ROWS
FROM FACT_ELECTRICITY f
LEFT JOIN DIM_LOCATION d
  ON f.LOCATION_ID = d.LOCATION_ID
WHERE d.LOCATION_ID IS NULL;
SELECT COUNT(*) AS ORPHAN_ROWS
FROM FACT_ELECTRICITY f
LEFT JOIN DIM_DATE d
  ON f.YEAR_ID = d.YEAR_ID
WHERE d.YEAR_ID IS NULL;

CREATE OR REPLACE TABLE FACT_COAL AS
SELECT
    iso_code AS LOCATION_ID,
    year AS YEAR_ID,
    COALESCE(coal_consumption, 0) AS CONSUMPTION,
    COALESCE(coal_production, 0) AS PRODUCTION,
    COALESCE(coal_electricity, 0) AS ELECTRICITY_GENERATED,
    COALESCE(coal_share_energy, 0) AS SHARE_OF_ENERGY
FROM OWID_ENERGY_DATA_RAW
WHERE iso_code IS NOT NULL
AND LENGTH(iso_code) = 3;

-- orphan check for FACT_COAL
SELECT COUNT(*) AS ORPHAN_ROWS
FROM FACT_COAL f
LEFT JOIN DIM_LOCATION d
  ON f.LOCATION_ID = d.LOCATION_ID
WHERE d.LOCATION_ID IS NULL;
SELECT COUNT(*) AS ORPHAN_ROWS
FROM FACT_COAL f
LEFT JOIN DIM_DATE d
  ON f.YEAR_ID = d.YEAR_ID
WHERE d.YEAR_ID IS NULL;

CREATE OR REPLACE TABLE FACT_OIL AS
SELECT
    iso_code AS LOCATION_ID,
    year AS YEAR_ID,
    COALESCE(oil_consumption, 0) AS CONSUMPTION,
    COALESCE(oil_production, 0) AS PRODUCTION,
    COALESCE(oil_electricity, 0) AS ELECTRICITY_GENERATED,
    COALESCE(oil_share_energy, 0) AS SHARE_OF_ENERGY
FROM OWID_ENERGY_DATA_RAW
WHERE iso_code IS NOT NULL
AND LENGTH(iso_code) = 3;

-- orphan check for FACT_OIL
SELECT COUNT(*) AS ORPHAN_ROWS
FROM FACT_OIL f
LEFT JOIN DIM_LOCATION d
  ON f.LOCATION_ID = d.LOCATION_ID
WHERE d.LOCATION_ID IS NULL;
SELECT COUNT(*) AS ORPHAN_ROWS
FROM FACT_OIL f
LEFT JOIN DIM_DATE d
  ON f.YEAR_ID = d.YEAR_ID
WHERE d.YEAR_ID IS NULL;

CREATE OR REPLACE TABLE FACT_GAS AS
SELECT
    iso_code AS LOCATION_ID,
    year AS YEAR_ID,
    COALESCE(gas_consumption, 0) AS CONSUMPTION,
    COALESCE(gas_production, 0) AS PRODUCTION,
    COALESCE(gas_electricity, 0) AS ELECTRICITY_GENERATED
FROM OWID_ENERGY_DATA_RAW
WHERE iso_code IS NOT NULL
AND LENGTH(iso_code) = 3;

-- orphan check for FACT_GAS
SELECT COUNT(*) AS ORPHAN_ROWS
FROM FACT_GAS f
LEFT JOIN DIM_LOCATION d
  ON f.LOCATION_ID = d.LOCATION_ID
WHERE d.LOCATION_ID IS NULL;
SELECT COUNT(*) AS ORPHAN_ROWS
FROM FACT_GAS f
LEFT JOIN DIM_DATE d
  ON f.YEAR_ID = d.YEAR_ID
WHERE d.YEAR_ID IS NULL;

CREATE OR REPLACE TABLE FACT_NUCLEAR AS
SELECT
    iso_code AS LOCATION_ID,
    year AS YEAR_ID,
    COALESCE(nuclear_consumption, 0) AS CONSUMPTION,
    COALESCE(nuclear_electricity, 0) AS ELECTRICITY_GENERATED,
    COALESCE(nuclear_share_energy, 0) AS SHARE_OF_ENERGY
FROM OWID_ENERGY_DATA_RAW
WHERE iso_code IS NOT NULL
AND LENGTH(iso_code) = 3;

-- orphan check for FACT_NUCLEAR
SELECT COUNT(*) AS ORPHAN_ROWS
FROM FACT_NUCLEAR f
LEFT JOIN DIM_LOCATION d
  ON f.LOCATION_ID = d.LOCATION_ID
WHERE d.LOCATION_ID IS NULL;
SELECT COUNT(*) AS ORPHAN_ROWS
FROM FACT_NUCLEAR f
LEFT JOIN DIM_DATE d
  ON f.YEAR_ID = d.YEAR_ID
WHERE d.YEAR_ID IS NULL;

CREATE OR REPLACE TABLE FACT_HYDRO AS
SELECT
    iso_code AS LOCATION_ID,
    year AS YEAR_ID,
    COALESCE(hydro_consumption, 0) AS CONSUMPTION,
    COALESCE(hydro_electricity, 0) AS ELECTRICITY_GENERATED
FROM OWID_ENERGY_DATA_RAW
WHERE iso_code IS NOT NULL
AND LENGTH(iso_code) = 3;

-- orphan check for FACT_HYDRO
SELECT COUNT(*) AS ORPHAN_ROWS
FROM FACT_HYDRO f
LEFT JOIN DIM_LOCATION d
  ON f.LOCATION_ID = d.LOCATION_ID
WHERE d.LOCATION_ID IS NULL;
SELECT COUNT(*) AS ORPHAN_ROWS
FROM FACT_HYDRO f
LEFT JOIN DIM_DATE d
  ON f.YEAR_ID = d.YEAR_ID
WHERE d.YEAR_ID IS NULL;

CREATE OR REPLACE TABLE FACT_SOLAR AS
SELECT
    iso_code AS LOCATION_ID,
    year AS YEAR_ID,
    COALESCE(solar_consumption, 0) AS CONSUMPTION,
    COALESCE(solar_electricity, 0) AS ELECTRICITY_GENERATED
FROM OWID_ENERGY_DATA_RAW
WHERE iso_code IS NOT NULL
AND LENGTH(iso_code) = 3;

-- orphan check for FACT_SOLAR
SELECT COUNT(*) AS ORPHAN_ROWS
FROM FACT_SOLAR f
LEFT JOIN DIM_LOCATION d
  ON f.LOCATION_ID = d.LOCATION_ID
WHERE d.LOCATION_ID IS NULL;
SELECT COUNT(*) AS ORPHAN_ROWS
FROM FACT_SOLAR f
LEFT JOIN DIM_DATE d
  ON f.YEAR_ID = d.YEAR_ID
WHERE d.YEAR_ID IS NULL;

CREATE OR REPLACE TABLE FACT_WIND AS
SELECT
    iso_code AS LOCATION_ID,
    year AS YEAR_ID,
    COALESCE(wind_consumption, 0) AS CONSUMPTION,
    COALESCE(wind_electricity, 0) AS ELECTRICITY_GENERATED
FROM OWID_ENERGY_DATA_RAW
WHERE iso_code IS NOT NULL
AND LENGTH(iso_code) = 3;

-- orphan check for FACT_WIND
SELECT COUNT(*) AS ORPHAN_ROWS
FROM FACT_WIND f
LEFT JOIN DIM_LOCATION d
  ON f.LOCATION_ID = d.LOCATION_ID
WHERE d.LOCATION_ID IS NULL;
SELECT COUNT(*) AS ORPHAN_ROWS
FROM FACT_WIND f
LEFT JOIN DIM_DATE d
  ON f.YEAR_ID = d.YEAR_ID
WHERE d.YEAR_ID IS NULL;

CREATE OR REPLACE TABLE FACT_BIOFUEL AS
SELECT
    iso_code AS LOCATION_ID,
    year AS YEAR_ID,
    COALESCE(biofuel_consumption, 0) AS CONSUMPTION,
    COALESCE(biofuel_electricity, 0) AS ELECTRICITY_GENERATED
FROM OWID_ENERGY_DATA_RAW
WHERE iso_code IS NOT NULL
AND LENGTH(iso_code) = 3;

-- orphan check for FACT_BIOFUEL
SELECT COUNT(*) AS ORPHAN_ROWS
FROM FACT_BIOFUEL f
LEFT JOIN DIM_LOCATION d
  ON f.LOCATION_ID = d.LOCATION_ID
WHERE d.LOCATION_ID IS NULL;
SELECT COUNT(*) AS ORPHAN_ROWS
FROM FACT_BIOFUEL f
LEFT JOIN DIM_DATE d
  ON f.YEAR_ID = d.YEAR_ID
WHERE d.YEAR_ID IS NULL;

CREATE OR REPLACE TABLE FACT_RENEWABLES_TOTAL AS
SELECT
    iso_code AS LOCATION_ID,
    year AS YEAR_ID,
    COALESCE(renewables_consumption, 0) AS TOTAL_CONSUMPTION,
    COALESCE(renewables_share_energy, 0) AS TOTAL_SHARE
FROM OWID_ENERGY_DATA_RAW
WHERE iso_code IS NOT NULL
AND LENGTH(iso_code) = 3;

-- orphan check for FACT_RENEWABLES_TOTAL
SELECT COUNT(*) AS ORPHAN_ROWS
FROM FACT_RENEWABLES_TOTAL f
LEFT JOIN DIM_LOCATION d
  ON f.LOCATION_ID = d.LOCATION_ID
WHERE d.LOCATION_ID IS NULL;
SELECT COUNT(*) AS ORPHAN_ROWS
FROM FACT_RENEWABLES_TOTAL f
LEFT JOIN DIM_DATE d
  ON f.YEAR_ID = d.YEAR_ID
WHERE d.YEAR_ID IS NULL;

CREATE OR REPLACE TABLE FACT_FOSSIL_TOTAL AS
SELECT
    iso_code AS LOCATION_ID,
    year AS YEAR_ID,
    COALESCE(fossil_fuel_consumption, 0) AS TOTAL_CONSUMPTION,
    COALESCE(fossil_share_energy, 0) AS TOTAL_SHARE
FROM OWID_ENERGY_DATA_RAW
WHERE iso_code IS NOT NULL
AND LENGTH(iso_code) = 3;

-- orphan check for FACT_FOSSIL_TOTAL
SELECT COUNT(*) AS ORPHAN_ROWS
FROM FACT_FOSSIL_TOTAL f
LEFT JOIN DIM_LOCATION d
  ON f.LOCATION_ID = d.LOCATION_ID
WHERE d.LOCATION_ID IS NULL;
SELECT COUNT(*) AS ORPHAN_ROWS
FROM FACT_FOSSIL_TOTAL f
LEFT JOIN DIM_DATE d
  ON f.YEAR_ID = d.YEAR_ID
WHERE d.YEAR_ID IS NULL;
