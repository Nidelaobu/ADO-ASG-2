/* User Story: Corporate Sustainability Benchmarking
Goal: Compare specific Country Performance vs. Calculated Global Averages
*/

CREATE OR REPLACE VIEW VIEW_SUSTAINABILITY_BENCHMARK AS
WITH Global_Averages AS (
-- 1. Calculate the Global Baseline for each year
SELECT
f.YEAR_ID,
AVG(f.TOTAL_SHARE) AS GLOBAL_AVG_RENEWABLE_PCT,
AVG(e.CARBON_INTENSITY) AS GLOBAL_AVG_CARBON_INTENSITY
FROM FACT_RENEWABLES_TOTAL f
JOIN FACT_ELECTRICITY e ON f.LOCATION_ID = e.LOCATION_ID AND f.YEAR_ID = e.YEAR_ID
GROUP BY f.YEAR_ID
)
SELECT
l.COUNTRY_NAME,
d.YEAR_ID,



-- Metric 1: Renewable Energy Trends
r.TOTAL_SHARE AS COUNTRY_RENEWABLES_PCT,
ROUND(ga.GLOBAL_AVG_RENEWABLE_PCT, 2) AS GLOBAL_AVG_RENEWABLES_PCT,
-- Benchmark Status: Renewable Leader?
CASE
    WHEN r.TOTAL_SHARE >= ga.GLOBAL_AVG_RENEWABLE_PCT THEN 'Above Global Avg'
    ELSE 'Below Global Avg'
END AS RENEWABLE_BENCHMARK_STATUS,
-- Metric 2: Emission Trends
e.CARBON_INTENSITY AS COUNTRY_CARBON_INTENSITY,
ROUND(ga.GLOBAL_AVG_CARBON_INTENSITY, 2) AS GLOBAL_AVG_CARBON_INTENSITY,
-- Benchmark Status: Low Carbon Leader?
CASE
    WHEN e.CARBON_INTENSITY <= ga.GLOBAL_AVG_CARBON_INTENSITY THEN 'Better than Global Avg'
    ELSE 'Worse than Global Avg'
END AS EMISSION_BENCHMARK_STATUS
FROM FACT_RENEWABLES_TOTAL r
JOIN FACT_ELECTRICITY e
ON r.LOCATION_ID = e.LOCATION_ID
AND r.YEAR_ID = e.YEAR_ID
JOIN DIM_LOCATION l
ON r.LOCATION_ID = l.LOCATION_ID
JOIN DIM_DATE d
ON r.YEAR_ID = d.YEAR_ID
JOIN Global_Averages ga
ON r.YEAR_ID = ga.YEAR_ID
ORDER BY l.COUNTRY_NAME, d.YEAR_ID;

select * from VIEW_SUSTAINABILITY_BENCHMARK;
